# Optimized Dockerfile using pre-built base image
ARG BASE_IMAGE=asia-northeast3-docker.pkg.dev/senior-mhealth-472007/ai-service/base:v9
FROM ${BASE_IMAGE}

# Security: Create non-root user
RUN useradd -m -u 1000 appuser && \
    mkdir -p /app /tmp/models /app/logs && \
    chown -R appuser:appuser /app /tmp/models

WORKDIR /app

# Copy only application code (not dependencies)
COPY --chown=appuser:appuser backend/ai-service/requirements*.txt ./
COPY --chown=appuser:appuser backend/ai-service/app ./app
COPY --chown=appuser:appuser backend/libraries ./libraries
COPY --chown=appuser:appuser backend/ai-service/start.sh ./
COPY --chown=appuser:appuser backend/config_loader.py ./
COPY --chown=appuser:appuser project.config.json ./

# CRITICAL: Force correct httpx version before other packages
RUN pip uninstall -y httpx openai && \
    pip install --no-cache-dir httpx==0.25.2 && \
    pip install --no-cache-dir --no-deps openai==1.35.0

# Install only Google Cloud dependencies not in base image
RUN pip install --no-cache-dir \
    google-cloud-storage==2.14.0 \
    google-cloud-firestore==2.14.0 \
    google-cloud-speech==2.23.0 \
    firebase-admin==6.4.0 \
    resampy==0.4.3

# Make start script executable
RUN chmod +x /app/start.sh

# Environment variables
ENV PYTHONPATH=/app:$PYTHONPATH \
    PYTHONUNBUFFERED=1 \
    PORT=8080 \
    GOOGLE_CLOUD_PROJECT=senior-mhealth-472007

# Switch to non-root user
USER appuser

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${PORT}/health || exit 1

EXPOSE 8080

CMD ["/app/start.sh"]